{"version":3,"file":"ngx-image-fallback.js","sources":["../../../projects/ngx-image-fallback/src/lib/ngx-image-fallback.directive.ts","../../../projects/ngx-image-fallback/src/lib/ngx-image-fallback.module.ts","../../../projects/ngx-image-fallback/src/public-api.ts","../../../projects/ngx-image-fallback/src/ngx-image-fallback.ts"],"sourcesContent":["import { Directive, ElementRef, Input, OnInit, Renderer2 } from '@angular/core';\n\nconst LOADER_COLOR = '#abcdef'; // loader color\nconst LOADER_CSS_CLASSNAME = 'image-fallback-loader'; // add this class while loading or class specified by user\nconst DIR_ERROR_CSS_CLASSNAME = 'image-fallback-error'; // add class on error (for user to decide if anything else to do)\nconst LOADER_STYLES = {\n  [`.${LOADER_CSS_CLASSNAME}::after`]: {\n    'separator': [':', ';'],\n    'border-radius': '50%',\n    'height': '15px',\n    'max-height': '100%',\n    'animation': '1s rotate linear infinite',\n    'content': '\" \"',\n    'inset': '0',\n    'display': 'block',\n    'aspect-ratio': '1',\n    'margin': 'auto',\n  },\n  '@keyframes rotate': {\n    'separator': ['', ''],\n    'from': '{transform: rotate(0deg);}',\n    'to': '{transform: rotate(360deg);}'\n  }\n};\nconst BKG_REGEX = /^url\\([\"']+.*[\"']+\\)$/i;\nconst DEFAULT_FALLBACK = [\n  'data:image/jpeg;base64,',\n  '/9j/4AAQSkZJRgABAQEAYABgAAD/',\n  '/gA7Q1JFQVRPUjogZ2QtanBlZyB2MS4wICh1c2luZyBJSkcgSlBFRyB2ODApLCBxdWFsaXR5ID0gODAK/',\n  '9sAQwAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCko/',\n  '9sAQwEHBwcKCAoTCgoTKBoWGigoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgo/',\n  '8AAEQgAIAAgAwEiAAIRAQMRAf/EABcAAQEBAQAAAAAAAAAAAAAAAAAEBQj/xAAcEAADAQEBAAMAAAAAAAAAAAAAAQIDERIEMVH/',\n  'xAAXAQEAAwAAAAAAAAAAAAAAAAAAAQID/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEh/9oADAMBAAIRAxEAPwDocAjrTTutVus4m/',\n  'CThM0UWAi97RvM1o6n2pfYST7+MtAGdv8AG00u04bl26XKS+zRAmIZ+WOy0z7NeZpPtWnxLpoAAf/Z',\n].join('');\n\ninterface LoaderStyles {\n  loaderClass?: string;\n  loaderColor?: string;\n}\n\n/**\n * Image fallback directive\n * @category Shared\n */\n@Directive({\n  selector: '[ngxImageFallback]'\n})\nexport class NgxImageFallbackDirective implements OnInit {\n\n  @Input()\n  ngxImageFallback: string = DEFAULT_FALLBACK;\n\n  @Input()\n  ngxImageFallbackStyles: LoaderStyles = { loaderClass: LOADER_CSS_CLASSNAME, loaderColor: LOADER_COLOR };\n\n  private isBackgroundImage = true;\n\n  constructor(\n    private readonly element: ElementRef,\n    private readonly renderer2: Renderer2\n  ) { }\n\n  /**\n   * Angular lifecycle init\n   */\n  ngOnInit(): void {\n    // inject native loader class class if not specified by user\n    if (!this.ngxImageFallbackStyles?.loaderClass || this.ngxImageFallbackStyles.loaderClass === LOADER_CSS_CLASSNAME) {\n      const id = LOADER_CSS_CLASSNAME;\n      if (!document.querySelector(`#${id}`)) {\n        const styles = Object.entries(LOADER_STYLES).map(\n          ([klassName, { separator, ...klassAttrs }]) => `${klassName}{${Object.entries(klassAttrs)\n            .map(([key, val]) => `${key}${separator[0]}${val}`)\n            .join(separator[1])\n            }}`\n        ).join(' ')\n          + `.${LOADER_CSS_CLASSNAME}::after{border-top:2px solid ${this.ngxImageFallbackStyles?.loaderColor || LOADER_COLOR}}`;\n        const style = this.renderer2.createElement('style');\n        const styleValues = this.renderer2.createText(styles);\n        this.renderer2.setAttribute(style, 'id', id);\n        this.renderer2.appendChild(style, styleValues);\n        this.renderer2.appendChild(document.head, style);\n      }\n    }\n\n    // extract image from host element\n    const source: string = this.element.nativeElement?.style?.backgroundImage || this.element.nativeElement?.src || '';\n    this.isBackgroundImage = BKG_REGEX.test(source) && this.element.nativeElement.nodeName.toLowerCase() !== 'img';\n    const sanitaizedSource = this.isBackgroundImage ? source.slice(5, source.length - 2) : source;\n    this.toggleLoader(true); // turn on loader\n\n    // If source is null/undefined/<blank>\n    if (['null', '', 'undefined'].includes(sanitaizedSource)) {\n      // On error show fallback add a class for user to decide on the host\n      this.showFallback(this.ngxImageFallback || DEFAULT_FALLBACK);\n      this.updateCssClass(DIR_ERROR_CSS_CLASSNAME, true);\n    } else {\n      //Simulate image load in background\n      const imageConnection = new Image();\n      imageConnection.src = sanitaizedSource;\n\n      // On error show fallback add a class for user to decide on the host\n      imageConnection.onerror = () => {\n        this.showFallback(this.ngxImageFallback || DEFAULT_FALLBACK);\n        this.updateCssClass(DIR_ERROR_CSS_CLASSNAME, true);\n      };\n\n      // on success turn off the loader\n      imageConnection.onload = () => {\n        this.toggleLoader(false);\n      };\n    }\n  }\n\n  /**\n   * Add fallback image\n   * \n   * @param fallbackImage fallback image url\n   */\n  showFallback(fallbackImage: string): void {\n    if (this.isBackgroundImage) {\n      // Welcome PR for multiple backgrounds\n      this.renderer2.setStyle(this.element.nativeElement, 'background-image', `url('${fallbackImage}')`);\n    } else {\n      this.renderer2.setAttribute(this.element.nativeElement, 'src', fallbackImage);\n    }\n    this.toggleLoader(false);\n  }\n\n  /**\n   * Add or remove the given classname to host\n   * \n   * @param klass css classname to add or remove\n   * @param mode true to add false to remove\n   */\n  updateCssClass(klass: string, mode: boolean): void {\n    const el = this.element.nativeElement;\n    if (mode) {\n      this.renderer2.addClass(el, klass);\n    } else {\n      this.renderer2.removeClass(el, klass);\n    }\n  }\n\n  /**\n   * Add/Remove loader\n   * \n   * @param mode true to add false to remove\n   */\n  toggleLoader(mode: boolean): void {\n    const el = this.element.nativeElement;\n    // img pseudo element hack\n    if (!this.isBackgroundImage) {\n      if (mode) {\n        this.renderer2.setStyle(el, 'content', '\" \"');\n      } else {\n        this.renderer2.removeStyle(el, 'content');\n      }\n    }\n    this.updateCssClass(this.ngxImageFallbackStyles?.loaderClass || LOADER_CSS_CLASSNAME, mode);\n  }\n\n}","import { NgModule } from '@angular/core';\nimport { NgxImageFallbackDirective } from './ngx-image-fallback.directive';\n\n\n\n@NgModule({\n  declarations: [\n    NgxImageFallbackDirective\n  ],\n  imports: [\n  ],\n  exports: [\n    NgxImageFallbackDirective\n  ]\n})\nexport class NgxImageFallbackModule { }\n","/*\n * Public API Surface of ngx-image-fallback\n */\n\nexport * from './lib/ngx-image-fallback.directive';\nexport * from './lib/ngx-image-fallback.module';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}